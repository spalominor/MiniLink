---
import { getSession } from 'auth-astro/server'
import { db } from 'astro:db'
import { User } from 'astro:db'
import { like } from 'astro:db'
import { getUserByEmail } from './utils/db'



// Importar los iconos de la carpeta components
import ChevronDown from './icons/Chevrone-down.astro'

const session = await getSession(Astro.request)

// Si el usuario no existe, guardaren la base de datos
if (session
    && session.user?.email
    && session.user?.name
) {
    const res = await getUserByEmail(session.user.email)

    if (res.success &&
        !res.data
    ) {
        await db.insert(User).values({
            email: session.user.email,
            name: session.user.name,
        })
    }
}

---

<header>
    {session
        ? (
            <div id="dropdown-menu">
                <div id="dropdown-label">
                    <span>{
                        session.user?.name 
                            ? session.user?.name.split(' ')[0]
                            : ' '
                    }</span>
                    <span id="chevron">
                        <ChevronDown width="24" heigt="24"/>
                    </span>
                </div>

                <div id="dropdown-content">
                    <nav>
                        <ul>
                            <li>
                                <a href="#">
                                    Ver mis URLs
                                </a>
                            </li>
                            <li>
                                <button id="logout">Logout</button>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        )
        : (
            <div>
                <button id="login">Login</button>
            </div>
        )
    }

</header>

<style>
    header {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        padding: 1rem;
        }
    
    button {
        border: none;
        cursor: pointer;
        font-size: 1.2rem;
        background-color: transparent;
    }

    #dropdown-menu {
        position: relative;
    }

    #dropdown-label {
        display: flex;
        align-items: center;
        cursor: pointer;
        width: fit-content;
        gap: 0.3rem;
    }

    #chevron {
        display: flex;
        align-items: center;
    }

    #dropdown-content {
        display: none;
        position: absolute;

        background-color: white;
        color: black;

        width: 200px;
        border-radius: 5px;

        padding: 0.5rem;
    }

    #dropdown-menu:hover #dropdown-content {
        display: block;
    }

    ul {
        list-style: none;
    }

    a {
        text-decoration: none;
        color: black;
    }
    
    a, button {
        font-size: 1.2rem;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        font-weight: 500;
    }

    a:hover, button:hover{
        color: gray;
    }

</style>

<script>
    const { signIn, signOut } = await import("auth-astro/client")

    const login = document.querySelector("#login") as HTMLButtonElement

    if (login) {
        login.onclick = () => signIn("google")
    }

    const logout = document.querySelector("#logout") as HTMLButtonElement

    if (logout) {
        logout.onclick = () => signOut()
    }
  </script>